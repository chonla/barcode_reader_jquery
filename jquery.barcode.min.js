/*
 * Barcode detector jQuery plugin
 * Author: Chonlasith Jucksriporn
 * Release:
 * June 7, 2013
 *  - Initial release.
 * June 11, 2013
 *  - Fix for old scanner.
 * June 11, 2013
 *  - Fix for old scanner.
 *  - Prevent callback if no barcode detected.
 * July 18, 2013
 *  - Make plugin chainable.
 * July 19, 2013
 *  - Prevent form submission on Enter detected.
 * September 26, 2013
 *  - Debug feature is added.
 *  - Fix reading problem in some barcode reader.
 * December 1, 2013
 *  - Fix reading problem in Metrologic barcode reader.
 *  - JSLint compatible.
 * January 27, 2014
 *  - Add ondata, triggered when data is detected.
 *  - Add data stream simulator, use .data -- use comma as a delimiter.
 *  - Refactor onkeyup, detach logic into separate function.
 * -----------------------------------------------
 * How to use
 * $(selector).barcode(options);
 *
 * Options:
 * options is written in JSON format with the following options
 * timeout : Time (millisecond) to start detection once barcode is scanned.
 * onbarcode : The callback function when a barcode is detected in selector.
 * debug : Debug flag (default=false).
 * data : data stream as char code string e.g. 56,56,55,48,48,49,55,49,55,53,13
 * ondata : The callback function when an input is detected.
 *
 * Parameters sent to callback:
 * target : HTML element invoking the event.
 * barcode : Barcode detected.
 * segments : Segmented barcode delimited in array.
 */
/*global $, jQuery*/
!function(a){"use strict";a.fn.barcode=function(b){var c={timeout:1e3,replacement:[[/#_16_##_220_#/,"|"],[/#_220_##_16_#/,"|"],[/#_17_##_77_#/g," "],[/#_17_##_86_#/g,"@CtrlV@"],[/#_86_##_17_#/g,"@CtrlV@"],[/#_16_##_45_#/g,"@CtrlV@"],[/#_45_##_16_#/g,"@CtrlV@"],[/#_13_#/g," "],[/#_144_#/g,""],[/#_(\d+)_#/g,function(a,b){return String.fromCharCode(b)}]],debug:!1},d=a(this),e=function(a,c){b.debug&&console&&console.log&&console.log("["+c+"] "+a)},f=function(c){c>=96&&105>=c&&(c-=48);var f=String.fromCharCode(c);a.isFunction(b.ondata)&&b.ondata(c,f),e("KeyUp","EVENT"),e("CharCode="+c,"INFO");var g=d;g.data("bar",void 0===g.data("bar")?"":g.data("bar"));var h=g.data("bar");h+="#_"+c+"_#",g.data("bar",h);var i=void 0===d.data("timer")?0:d.data("timer");0!==i&&(clearTimeout(i),d.data("timer",0));var j=setTimeout(function(){var d,c=g.data("bar");for(d in b.replacement)b.replacement.hasOwnProperty(d)&&(c=c.replace(b.replacement[d][0],b.replacement[d][1]));if("@CtrlV@"===c&&(c=g.val().replace(/(\r\n|\n|\r)/g," ")),c=c.replace(/@CtrlV@/g,""),c=c.replace(/^\s+/,"").replace(/\s+$/,""),c.length>1){var f=c.split(" ");a.isFunction(b.onbarcode)&&(e("Callback onBarcode()","INFO"),e("Read barcode"+f,"INFO"),b.onbarcode(g[0],c,f))}g.val(""),g.data("bar","")},b.timeout);return d.data("timer",j),!0};if(b=a.extend(c,b),d.on("click",function(){e("Click","EVENT"),d.select()}).on("keyup",function(a){var b=a.which;return f(b)}).on("keydown",function(a){return 13===a.which?!1:!0}),e("Initialize","EVENT"),b.data){var g=b.data.split(","),h=0;for(h=0;h<g.length;h++)f(g[h])}return this}}(jQuery);