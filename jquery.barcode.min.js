/*
 * Barcode detector jQuery plugin customized for TMX
 * Author: Chonlasith Jucksriporn
 * Release:
 * June 7, 2013
 *  - Initial release.
 * June 11, 2013
 *  - Fix for old scanner.
 * June 11, 2013
 *  - Fix for old scanner.
 *  - Prevent callback if no barcode detected.
 * July 18, 2013
 *  - Make plugin chainable.
 * July 19, 2013
 *  - Prevent form submission on Enter detected.
 * September 26, 2013
 *  - Debug feature is added.
 *  - Fix reading problem in some barcode reader.
 * December 1, 2013
 *  - Fix reading problem in Metrologic barcode reader.
 *  - JSLint compatible.
 * -----------------------------------------------
 * How to use
 * $(selector).barcode(options);
 *
 * Options:
 * options is written in JSON format with the following options
 * timeout : Time (millisecond) to start detection once barcode is scanned.
 * onbarcode : The callback function when a barcode is detected in selector.
 * debug : Debug flag (default=false).
 *
 * Parameters sent to callback:
 * target : HTML element invoking the event.
 * barcode : Barcode detected.
 * segments : Segmented barcode delimited in array.
 */
/*global $, jQuery*/
!function(a){"use strict";a.fn.barcode=function(b){var c={timeout:1e3,replacement:[[/#_16_##_220_#/,"|"],[/#_220_##_16_#/,"|"],[/#_17_##_77_#/g," "],[/#_17_##_86_#/g,"@CtrlV@"],[/#_86_##_17_#/g,"@CtrlV@"],[/#_16_##_45_#/g,"@CtrlV@"],[/#_45_##_16_#/g,"@CtrlV@"],[/#_13_#/g," "],[/#_(\d+)_#/g,function(a,b){return String.fromCharCode(b)}]],debug:!1},d=function(a,c){b.debug&&console&&console.log&&console.log("["+c+"] "+a)};return b=a.extend(c,b),a(this).on("click",function(){d("Click","EVENT"),a(this).select()}).on("keyup",function(c){var e=c.which;e>=96&&105>=e&&(e-=48),String.fromCharCode(e),d("KeyUp","EVENT"),d("CharCode="+e,"INFO");var g=a(this);g.data("bar",void 0===g.data("bar")?"":g.data("bar"));var h=g.data("bar");h+="#_"+e+"_#",g.data("bar",h);var i=void 0===a(this).data("timer")?0:a(this).data("timer");0!==i&&(clearTimeout(i),a(this).data("timer",0));var j=setTimeout(function(){var e,c=g.data("bar");for(e in b.replacement)b.replacement.hasOwnProperty(e)&&(c=c.replace(b.replacement[e][0],b.replacement[e][1]));if("@CtrlV@"===c&&(c=g.val().replace(/(\r\n|\n|\r)/g," ")),c=c.replace(/@CtrlV@/g,""),c=c.replace(/^\s+/,"").replace(/\s+$/,""),c.length>1){var f=c.split(" ");a.isFunction(b.onbarcode)&&(d("Callback onBarcode()","INFO"),d("Read barcode"+f,"INFO"),b.onbarcode(g[0],c,f))}g.val(""),g.data("bar","")},b.timeout);return a(this).data("timer",j),!0}).on("keydown",function(a){return 13===a.which?!1:!0}),d("Initialize","EVENT"),this}}(jQuery);